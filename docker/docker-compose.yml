# =============================================================================
# OpenClaw Docker Compose Configuration
# =============================================================================
# This compose file builds and runs the OpenClaw gateway container.
# All dependencies are baked into the image via the Dockerfile for fast restarts.
#
# Commands:
#   Build:   docker-compose build
#   Start:   docker-compose up -d
#   Rebuild: docker-compose up -d --build
#   Logs:    docker-compose logs -f
# =============================================================================

version: "3.8"

services:
  openclaw-gateway:
    # Build from local Dockerfile instead of pulling a base image
    # This bakes in all dependencies for fast, reliable restarts
    build:
      context: .
      dockerfile: Dockerfile
    
    # Tag the built image for easier management
    image: openclaw-gateway:latest
    
    container_name: openclaw-gateway
    restart: unless-stopped
    working_dir: /app
    
    ports:
      - "18789:18789"
    
    volumes:
      # Persist OpenClaw state and configuration
      # On EC2, these map to /home/ec2-user/.openclaw
      - ${OPENCLAW_CONFIG_PATH:-~/.openclaw}:/root/.openclaw
      - ${OPENCLAW_WORKSPACE_PATH:-~/.openclaw/workspace}:/root/.openclaw/workspace
    
    environment:
      # AWS_PROFILE=default is a workaround for OpenClaw's credential detection
      # which only checks env vars, not IMDS. See: https://docs.openclaw.ai/bedrock
      - AWS_PROFILE=default
      # AWS Bedrock configuration (credentials come from IAM instance role)
      - AWS_REGION=${AWS_REGION:-eu-west-1}
      - AWS_DEFAULT_REGION=${AWS_REGION:-eu-west-1}
      # OpenClaw settings
      - NODE_ENV=production
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
